#  TODO List

项目中有较多改进和完善的地方，逐个进行介绍

### 输入和输出支持

目前输入只支持从系统提供的API构建网络模型，网络模型的参数为随机值，需要支持从ONNX文件中读取网络结构以及参数。同时输出中的张量数据也是随机生成的，无法作为一个推理工具得到输出结果，初步设想是使用protobuf设计一种文件格式保存网络结构和参数，直接对接Ansor(如果Ansor只支持python文件，可以从现有的输出文件解析出需要的python文件)。

### 自动化正确性测试工具

目前的正确性验证是手工测试的，测试不全面且存在出错的可能性。正确性测试可以分为两个方面，首先是对于每一个模式匹配规则进行测试，模式匹配前与模式匹配后的张量需要保持一致，可以只对模式匹配的子图进行测试，也可以是整个网络进行一次模式匹配就测试一次。第二个正确性测试是只对比输出张量是否一致，对中间状态的张量不需要进行测试，此种方法需要在完成“输入输出支持”可以得到一个确定的推理结果之后进行。对于结果不一致的情况，应该有对应的调试机制。

### C++的实现

main函数中只包含几个注释的测试函数，可以根据输入参数的不同选择执行不同的网络，得到不同的输出文件。

在实现时在源文件标注了TODO、FIXME字样，可以逐个分析有必要改进或者实现（FIXME需要改正）。

### python封装

目前整个项目是基于C++构建的，可以使用Cython构建python的接口，使用python调用c++。目前不考虑python与c++的其他交互方式，例如c++调用python。

### 模式匹配规则

一些模式匹配规则修改后会导致程序出错，正在修复，目前可能一些网络无法通过编译。同时一些模式匹配规则实现比较hack而且可能有内存泄漏的问题，可以进行重构。目前的22条规则也不禁完善，要将常见的框架的算子级别的模式匹配规则转化为子算子的模式匹配规则，这一点要逐个网络、逐条规则进行分析，模式匹配规则是否完善决定着推理性能是否足够优秀，值得继续深入探索。

### 参数预处理

参数预处理是通过展开为循环实现的，占编译的主要时间。应该选择一种别的机制或者对现有方式进行优化降低参数预处理的时间。

### 无法用子算子表达的算子

子算子的核心概念就是循环的轴，当一个算子无法用轴来表示，或者算子中有动态控制流，这就超过了子算子的表达能力。对于此类算子，子算子体系无法对其进行图优化，但是可以通过设置一个黑盒子算子，不对其设置模式匹配规则，直接将其转化为后端的形式来表达网络。

### 图优化的autotuning机制

在一些模式匹配规则的实现中增加了比较多的限制，可以去掉一些限制得到不同的图优化结构；另一方面，有些模式匹配规则是否会带来代价降低也较难衡量，可以设计一些开关进行autotuning。但图优化的结果不同需要的算子调优也会不同，会带来一个O(n*m)的调优时间，显然是不可接受的，需要考虑一种机制进行图优化的autotuning。

### Ansor任务数量

对比Relay生成的Ansor任务(task)数量，本项目生成的task明显更多，原因是本项目将每个函数都作为一个不同的Ansor任务，但是一些函数的函数体是完全相同的，有些除了shape不同外其他也相同，所以可以不用重复创建调度任务，直接使用相同的调优结果即可。实现方式可以给每个函数一个hash值，如果hash值相同则代表是相同的函数，不需要重复创建。

### 数据结构

Presburger Formula的数据结构使用的是表达式树，以为着两个语义相同的Formula无法判断语义相同，目前的相同判断只能判断表达式树完全一致。另外Presburger Formula添加存在量词、全称量词可以推断出变量的范围，这一点类似与isl，但要不要实现取决于图优化的需求。同样，Polynomial表达式也是同样的道理，不确定是否可以改进。

### 数据布局转化 AlterOpLayout

目前的系统只能完成代数优化和算子融合，没有数据布局转化的优化。在与relay的性能对比实验中也是关闭了relay的AlterOpLayout的pass，若不关闭性能可能无法超过relay。若要实现数据布局转化，要分别实现不同版本的算子（例如nchw的卷积和nhwc的卷积），进行数据布局的转换。具体选择数据布局转化的哪一个可以使用autotuning机制。

### Winograd算法实现

在TOPI中给出winograd_nhwc的示例，目前系统给出了winograd_nchw的实现，但是性能不如relay版本，这是关闭relay的AlterOpLayout的一个主要原因。改进方案设想： winograd改为nhwc实现，winograd需要的常数矩阵ABG不再作为函数签名（完全仿照TOPI实现）

### 更多后端的探索

目前只选择Ansor作为后端，Ansor调优时间较长。可以考虑更多的后端方式（算子库的方式不再考虑范围内），例如多面体模型(Polynomial)或者接入MLIR。或者自己实现一个对应的后端，那么其作为推理工具包含图优化和算子优化就成为一个成熟的工具了。

### 更多图优化方式的探索

例如静态内存分配、数据流优化(CSE DCE)等。

